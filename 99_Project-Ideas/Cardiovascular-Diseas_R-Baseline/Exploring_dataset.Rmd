---
title: "Cardiovascular Disease - Dataset Check"
author: "Thilo Sander"
date: "19 2 2021"
output: 
  html_document:
    toc: FALSE
    number_sections: FALSE
    highlight: tango
    theme: cosmo
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


<b>
<b>
<b>
<b>
# Raw data inspection


```{r Loading libraries}
set.seed(42) #for consistent results


# All necessary libraries used in the code
library(dplyr) # to wrangle our data
library(tidyr) # to wrangle our data - pivot_longer()
library(ggplot2) # to render our graphs
library(readr) # for loading the .csv data
library(kableExtra) # to render better formatted tables
library(stargazer) # for formatting your model output

raw_data <- read.csv("cardio_train.csv", sep = ";")
head(raw_data)

```

```{r BMI}
# Include BMI and transform age
data_incl_BMI <- raw_data %>% 
  dplyr::mutate(BMI = raw_data$weight / ((raw_data$height/100) ** 2)) %>% 
  dplyr::mutate(age_year = age/365)


```
<b>
<b>
<b>

```{r Plots}
# Plot BMI vs. Age
ggplot(data = data_incl_BMI,
       aes( x = age_year,
            y = BMI,
            color = factor(cardio))) +
  geom_point() +
  geom_hline(yintercept = 15) +
  geom_hline(yintercept = 40) +
  geom_vline(xintercept = 35) +
  geom_vline(xintercept = 70) +
  labs(y = "BMI",
       x = "Age",
       caption = "Filter BMI von 15 bis 40 | Filter Age von 35 bis 70") +
  theme_minimal()

# Plot Ap_Hi vs. Age
ggplot(data = data_incl_BMI,
       aes( x = age_year,
            y = ap_hi,
            color = factor(cardio))) +
  geom_point() +
  geom_hline(yintercept = 50) +
  geom_hline(yintercept = 225) +
  geom_vline(xintercept = 35) +
  geom_vline(xintercept = 70) +
  labs(y = "BMI",
       x = "Age",
       caption = "Filter systolic blood pressure von 50 bis 225 | Filter Age von 35 bis 70") +
  theme_minimal()
  
# Plot Ap_Lo vs. Age
ggplot(data = data_incl_BMI,
       aes( x = age_year,
            y = ap_lo,
            color = factor(cardio))) +
  geom_point() +
  geom_hline(yintercept = 40) +
  geom_hline(yintercept = 125) +
  geom_vline(xintercept = 35) +
  geom_vline(xintercept = 70) +
  labs(y = "BMI",
       x = "Age",
       caption = "Filter diastolic blood pressure von 40 bis 125 | Filter Age von 35 bis 70") +
  theme_minimal()


```

<b>
<b>
<b>

```{r}
# Check integer values (Cholesterol - Glucose - Smoke - Alcohol - Activity)
data_incl_BMI %>% 
  dplyr::group_by(data_incl_BMI$cholesterol) %>% 
  summarise(count = n())

data_incl_BMI %>% 
  dplyr::group_by(data_incl_BMI$gluc) %>% 
  summarise(count = n())

data_incl_BMI %>% 
  dplyr::group_by(data_incl_BMI$smoke) %>% 
  summarise(count = n())

data_incl_BMI %>% 
  dplyr::group_by(data_incl_BMI$alco) %>% 
  summarise(count = n())

data_incl_BMI %>% 
  dplyr::group_by(data_incl_BMI$active) %>% 
  summarise(count = n())

data_incl_BMI %>% 
  dplyr::group_by(data_incl_BMI$gender) %>% 
  summarise(count = n())

## --> Keine Auffäligkeiten bei Cholesterol, GLucose, Smoke, Alcohol and Activity
## Frauen sind nur ca. halb so viele wie Männer (gehe mal davon aus, dass 2 = Frauen ist)
```


<b>
<b>
<b>

# Filtering

You can also embed plots, for example:

```{r}

# Filter BMI (15 bis 40)
# Filter Age (35 bis 70)
# ap_hi (50 bis 225)
# ap_lo (40 bis 125)

cleaned_data <- data_incl_BMI %>% 
  dplyr::filter(  data_incl_BMI$BMI > 15 & 
                  data_incl_BMI$BMI < 40 & 
                  data_incl_BMI$age_year > 35 & 
                  data_incl_BMI$age_year < 70 & 
                  data_incl_BMI$ap_hi > 50 & 
                  data_incl_BMI$ap_hi < 225 &
                  data_incl_BMI$ap_lo > 40 & 
                  data_incl_BMI$ap_lo < 125)
```

# Split data into test and training set
```{r}
dt = sort(sample(nrow(cleaned_data), nrow(cleaned_data)*.8))
train_set<-cleaned_data[dt,]
test_set<-cleaned_data[-dt,]
```
<b>
<b>
<b>
<b>
<b>


# Model-Creation: Linear Regression

```{r, results="asis"}
# Simple linear model with all variables (BMI not used, as it is dependent on height and weight)
model_all <- lm(cardio ~ age_year + gender + height + weight + ap_hi + ap_lo + cholesterol + gluc + smoke + alco + active, data = train_set)

# Simple linear model using BMI instead of height and weight
model_BMI <- lm(cardio ~ BMI + age_year + gender + ap_hi + ap_lo + cholesterol + gluc + smoke + alco + active, data = train_set)

# Simple linear model using BMI and no subjective data (alcohol, sport, smoke)
model_BMI_objective <- lm(cardio ~ BMI + age_year + gender + ap_hi + ap_lo + cholesterol + gluc, data = train_set)


stargazer::stargazer(model_all, model_BMI, model_BMI_objective, type="html")
```

<b>
<b>
<b>
<b>
<b>

# Model-Prediction Linear Model

```{r}

test_set["cardio_predict_all"] <- as.data.frame(predict(model_all, newdata = test_set))
test_set["cardio_predict_BMI"] <- as.data.frame(predict(model_BMI, newdata = test_set))
test_set["cardio_predict_BMI_obj"] <- as.data.frame(predict(model_BMI_objective, newdata = test_set))


head(test_set)





```
<b>
<b>
<b>
<b>
<b>

# Model-Evaluation Linear Model

```{r}

# Rounding to 0 and 1
test_set <- test_set %>% 
  dplyr::mutate(cardio_predict_all_bin = round(cardio_predict_all, digits = 0)) %>% 
  dplyr::mutate(cardio_predict_BMI_bin = round(cardio_predict_BMI, digits = 0)) %>%
  dplyr::mutate(cardio_predict_BMI_obj_bin = round(cardio_predict_BMI_obj, digits = 0))

# Difference of (binary) predictions to real value 

diffs <- test_set %>% 
  dplyr::mutate(diff_model_all = abs(cardio - cardio_predict_all)) %>%
  dplyr::mutate(diff_model_BMI = abs(cardio - cardio_predict_BMI)) %>%
  dplyr::mutate(diff_model_BMI_obj = abs(cardio - cardio_predict_BMI_obj)) %>%
  dplyr::mutate(diff_model_all_bin = abs(cardio - cardio_predict_all_bin)) %>%
  dplyr::mutate(diff_model_BMI_bin = abs(cardio - cardio_predict_BMI_bin)) %>%
  dplyr::mutate(diff_model_BMI_obj_bin = abs(cardio - cardio_predict_BMI_obj_bin)) %>%
  dplyr::summarise(sum(diff_model_all), sum(diff_model_BMI), sum(diff_model_BMI_obj), sum(diff_model_all_bin), sum(diff_model_BMI_bin), sum(diff_model_BMI_obj_bin))




t(diffs)

```

<b>
<b>



<b>
<b>
<b>
<b>


# Logistic Regression


## Model-Prediction
```{r}
# Simple logistic regression model (Only BMI and objective data)
model_BMI_obj_log <- glm(cardio ~ BMI + age_year + gender + ap_hi + ap_lo + cholesterol + gluc, data = train_set, family = binomial)


stargazer::stargazer(model_BMI_objective, model_BMI_obj_log, type="html")
```
<b>
<b>





## Model Prediction Logistic Model
```{r}
test_set["cardio_predict_BMI_obj_log"] <- as.data.frame(predict(model_BMI_obj_log, newdata = test_set, type = "response"))

head(test_set)
```

<b>
<b>
<b>
<b>
<b>
<b>
<b>
<b>
<b>
<b>




# Model Evaluation Model
```{r}
# Rounding to 0 and 1
test_set <- test_set %>% 
  dplyr::mutate(cardio_predict_BMI_obj_log_bin = round(cardio_predict_BMI_obj_log, digits = 0))

# Difference of (binary) predictions to real value 

diffs <- test_set %>% 
  dplyr::mutate(diff_model_all = abs(cardio - cardio_predict_all)) %>%
  dplyr::mutate(diff_model_BMI = abs(cardio - cardio_predict_BMI)) %>%
  dplyr::mutate(diff_model_BMI_obj = abs(cardio - cardio_predict_BMI_obj)) %>%
  dplyr::mutate(diff_model_all_bin = abs(cardio - cardio_predict_all_bin)) %>%
  dplyr::mutate(diff_model_BMI_bin = abs(cardio - cardio_predict_BMI_bin)) %>%
  dplyr::mutate(diff_model_BMI_obj_bin = abs(cardio - cardio_predict_BMI_obj_bin)) %>%
  dplyr::mutate(diff_model_BMI_obj_log = abs(cardio - cardio_predict_BMI_obj_log)) %>%
  dplyr::mutate(diff_model_BMI_obj_log_bin = abs(cardio - cardio_predict_BMI_obj_log_bin)) %>%
  dplyr::summarise(sum(diff_model_all), sum(diff_model_BMI), sum(diff_model_BMI_obj), sum(diff_model_all_bin), sum(diff_model_BMI_bin), sum(diff_model_BMI_obj_bin), sum(diff_model_BMI_obj_log), sum(diff_model_BMI_obj_log_bin))




t(diffs)
```

<b>


```{r}
best_fit_perc_lin <- data.frame(1-(min(diffs)/nrow(test_set)))
colnames(best_fit_perc_lin) <- c("Best Accuracy Linear")
best_fit_perc_lin

```

<b>
<b>
<b>


The Best Accuracy is 73.2%. In the clean data set 66820 of 70000 data points are included. Logistic model is not better than linear fit.

<b>
<b>
<b>
<b>
<b>
<b>
<b>
<b>
<b>

